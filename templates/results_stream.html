{% extends "base.html" %}

{% block title %}Analysis Results - Notebook Analyzer{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div id="streamingResults" class="d-none">
        <!-- This will be populated by JavaScript when results arrive -->
    </div>
    
    <div id="streamingError" class="d-none">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="alert alert-danger">
                    <h5><i class="bi bi-exclamation-triangle me-2"></i>Analysis Failed</h5>
                    <p id="errorMessage"></p>
                    <a href="{{ url_for('index') }}" class="btn btn-outline-danger">
                        <i class="bi bi-arrow-left me-1"></i>Try Again
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Store analysis data globally for copy function
let globalAnalysisData = null;

document.addEventListener('DOMContentLoaded', function() {
    // Get analysis results from sessionStorage (set by streaming interface)
    const resultsData = sessionStorage.getItem('analysisResults');
    if (resultsData) {
        try {
            const data = JSON.parse(resultsData);
            globalAnalysisData = data; // Store for copy function
            displayResults(data);
            sessionStorage.removeItem('analysisResults'); // Clean up
        } catch (e) {
            showError('Failed to parse analysis results');
        }
    } else {
        showError('No analysis results found');
    }
});

function displayResults(data) {
    const container = document.getElementById('streamingResults');
    const analysis = data.analysis;
    const sourceName = data.source_name;
    const sourceType = data.source_type;
    
    container.innerHTML = `
        <div class="row">
            <div class="col-12">
                <!-- Header -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h2 class="text-nvidia mb-1">
                            <i class="bi bi-clipboard-data me-2"></i>
                            Analysis Results
                        </h2>
                        <p class="text-muted mb-0">
                            ${sourceType === 'file' ? 
                                `<i class="bi bi-file-earmark-code me-1"></i>File: ${sourceName}` :
                                `<i class="bi bi-link-45deg me-1"></i>URL: <a href="${sourceName}" target="_blank" class="text-decoration-none">${sourceName}</a>`
                            }
                        </p>
                    </div>
                    <div class="btn-group">
                        <button id="copyResults" class="btn btn-outline-nvidia" onclick="copyResultsToClipboard()">
                            <i class="bi bi-clipboard me-1"></i>
                            Copy Results
                        </button>
                        <a href="/" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left me-1"></i>
                            Analyze Another
                        </a>
                    </div>
                </div>

                <!-- Main Results Grid -->
                <div class="row">
                    <!-- GPU Requirements -->
                    <div class="col-lg-8 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="bi bi-gpu-card me-2"></i>
                                    GPU Requirements
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <!-- Minimum Configuration -->
                                    <div class="col-md-6 mb-3">
                                        <div class="border-start border-warning border-3 ps-3">
                                            <h6 class="text-warning mb-2">
                                                <i class="bi bi-shield-fill-exclamation me-1"></i>
                                                Minimum Requirements
                                            </h6>
                                            <div class="mb-2">
                                                <strong>GPU:</strong> 
                                                <span class="badge bg-warning text-dark ms-1">${analysis.min_gpu.type}</span>
                                            </div>
                                            <div class="mb-2">
                                                <strong>Quantity:</strong> ${analysis.min_gpu.quantity}
                                            </div>
                                            <div class="mb-2">
                                                <strong>VRAM:</strong> ${analysis.min_gpu.vram_gb} GB
                                            </div>
                                            <div class="mb-0">
                                                <strong>Runtime:</strong> 
                                                <span class="text-muted">${analysis.min_gpu.runtime}</span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Optimal Configuration -->
                                    <div class="col-md-6 mb-3">
                                        <div class="border-start border-success border-3 ps-3">
                                            <h6 class="text-success mb-2">
                                                <i class="bi bi-rocket-takeoff me-1"></i>
                                                Optimal Configuration
                                            </h6>
                                            <div class="mb-2">
                                                <strong>GPU:</strong> 
                                                <span class="badge bg-success ms-1">${analysis.optimal_gpu.type}</span>
                                            </div>
                                            <div class="mb-2">
                                                <strong>Quantity:</strong> ${analysis.optimal_gpu.quantity}
                                            </div>
                                            <div class="mb-2">
                                                <strong>VRAM:</strong> ${analysis.optimal_gpu.vram_gb} GB
                                            </div>
                                            <div class="mb-0">
                                                <strong>Runtime:</strong> 
                                                <span class="text-muted">${analysis.optimal_gpu.runtime}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Additional Requirements -->
                                <div class="row mt-3">
                                    <div class="col-md-6">
                                        <div class="small">
                                            <strong>SXM Required:</strong>
                                            ${analysis.sxm_required ? 
                                                '<span class="badge bg-info ms-1">Yes</span>' :
                                                '<span class="badge bg-secondary ms-1">No</span>'
                                            }
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="small">
                                            <strong>ARM Compatibility:</strong>
                                            ${getArmCompatibilityBadge(analysis.arm_compatibility)}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Compliance & Confidence -->
                    <div class="col-lg-4 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="bi bi-speedometer2 me-2"></i>
                                    Assessment Metrics
                                </h6>
                            </div>
                            <div class="card-body text-center">
                                <!-- Compliance Score -->
                                <div class="mb-3">
                                    <div class="compliance-score ${getComplianceClass(analysis.nvidia_compliance_score)}">
                                        ${analysis.nvidia_compliance_score}/100
                                    </div>
                                    <small class="text-muted">NVIDIA Compliance Score</small>
                                </div>

                                <!-- Confidence -->
                                <div class="mb-3">
                                    <div class="compliance-score text-primary">
                                        ${analysis.confidence}%
                                    </div>
                                    <small class="text-muted">Analysis Confidence</small>
                                </div>

                                <!-- Enhancement Status -->
                                ${analysis.llm_enhanced ?
                                    '<span class="badge bg-nvidia"><i class="bi bi-robot me-1"></i>LLM Enhanced</span>' :
                                    '<span class="badge bg-secondary"><i class="bi bi-gear me-1"></i>Static Analysis</span>'
                                }
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Detailed Analysis -->
                <div class="row">
                    <!-- Reasoning -->
                    <div class="col-lg-6 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="bi bi-lightbulb me-2"></i>
                                    Analysis Reasoning
                                </h6>
                            </div>
                            <div class="card-body">
                                ${analysis.reasoning ? analysis.reasoning.map(reason => 
                                    `<div class="reasoning-item">${reason}</div>`
                                ).join('') : ''}
                                
                                ${analysis.llm_reasoning && analysis.llm_reasoning.length > 0 ? `
                                    <h6 class="mt-3 text-nvidia">
                                        <i class="bi bi-robot me-1"></i>
                                        LLM Insights
                                    </h6>
                                    ${analysis.llm_reasoning.map(reason => 
                                        `<div class="reasoning-item">${reason}</div>`
                                    ).join('')}
                                ` : ''}
                            </div>
                        </div>
                    </div>

                    <!-- Compliance Details -->
                    <div class="col-lg-6 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="bi bi-shield-check me-2"></i>
                                    NVIDIA Compliance
                                </h6>
                            </div>
                            <div class="card-body">
                                ${renderComplianceDetails(analysis)}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    container.classList.remove('d-none');
}

function copyResultsToClipboard() {
    const copyBtn = document.getElementById('copyResults');
    const originalText = copyBtn.innerHTML;
    
    try {
        let formattedText;
        
        // Use global analysis data (sessionStorage is cleared after display)
        if (!globalAnalysisData) {
            // Fallback: try to extract from DOM like the regular results page
            const analysisData = extractAnalysisDataFromDOM();
            formattedText = createShareableText(analysisData, analysisData.source_name, analysisData.source_type);
        } else {
            // Create formatted text for sharing
            formattedText = createShareableText(globalAnalysisData.analysis, globalAnalysisData.source_name, globalAnalysisData.source_type);
        }
        
        // Copy to clipboard
        navigator.clipboard.writeText(formattedText).then(() => {
            showCopySuccess(copyBtn, originalText);
        }).catch(err => {
            // Fallback for older browsers
            fallbackCopyTextToClipboard(formattedText);
            showCopySuccess(copyBtn, originalText);
        });
    } catch (err) {
        console.error('Error copying results:', err);
        showCopyError(copyBtn, originalText);
    }
}

function createShareableText(analysis, sourceName, sourceType) {
    const sourceInfo = sourceType === 'file' ? 
        `üìÑ File: ${sourceName}` : 
        `üîó URL: ${sourceName}`;
    
    let text = `üöÄ **GPU Analysis Results**
${sourceInfo}

**üíæ Minimum Requirements:**
‚Ä¢ GPU: ${analysis.min_gpu.type}
‚Ä¢ Quantity: ${analysis.min_gpu.quantity}
‚Ä¢ VRAM: ${analysis.min_gpu.vram_gb} GB
‚Ä¢ Runtime: ${analysis.min_gpu.runtime}

**‚ö° Optimal Configuration:**
‚Ä¢ GPU: ${analysis.optimal_gpu.type}
‚Ä¢ Quantity: ${analysis.optimal_gpu.quantity}
‚Ä¢ VRAM: ${analysis.optimal_gpu.vram_gb} GB
‚Ä¢ Runtime: ${analysis.optimal_gpu.runtime}

**üìä Technical Details:**
‚Ä¢ SXM Required: ${analysis.sxm_required ? 'Yes' : 'No'}
‚Ä¢ ARM Compatibility: ${analysis.arm_compatibility}
‚Ä¢ NVIDIA Compliance: ${analysis.nvidia_compliance_score}/100
‚Ä¢ Analysis Confidence: ${analysis.confidence}%
‚Ä¢ Enhancement: ${analysis.llm_enhanced ? 'LLM Enhanced' : 'Static Analysis'}`;

    // Add key reasoning if available
    if (analysis.reasoning && analysis.reasoning.length > 0) {
        text += `\n\n**üîç Key Analysis Points:**`;
        analysis.reasoning.slice(0, 5).forEach(reason => {
            text += `\n‚Ä¢ ${reason}`;
        });
    }

    // Add LLM insights if available
    if (analysis.llm_reasoning && analysis.llm_reasoning.length > 0) {
        text += `\n\n**ü§ñ AI Insights:**`;
        analysis.llm_reasoning.slice(0, 3).forEach(reason => {
            text += `\n‚Ä¢ ${reason}`;
        });
    }

    text += `\n\n---\nüìù Analysis generated by Notebook Analyzer`;
    
    return text;
}

function showCopySuccess(copyBtn, originalText) {
    copyBtn.innerHTML = '<i class="bi bi-check-circle me-1"></i>Copied!';
    copyBtn.classList.remove('btn-outline-nvidia');
    copyBtn.classList.add('btn-success');
    
    setTimeout(() => {
        copyBtn.innerHTML = originalText;
        copyBtn.classList.remove('btn-success');
        copyBtn.classList.add('btn-outline-nvidia');
    }, 2000);
}

function showCopyError(copyBtn, originalText) {
    copyBtn.innerHTML = '<i class="bi bi-exclamation-triangle me-1"></i>Error';
    copyBtn.classList.remove('btn-outline-nvidia');
    copyBtn.classList.add('btn-danger');
    
    setTimeout(() => {
        copyBtn.innerHTML = originalText;
        copyBtn.classList.remove('btn-danger');
        copyBtn.classList.add('btn-outline-nvidia');
    }, 2000);
}

function fallbackCopyTextToClipboard(text) {
    const textArea = document.createElement("textarea");
    textArea.value = text;
    textArea.style.position = "fixed";
    textArea.style.top = "0";
    textArea.style.left = "0";
    
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
        document.execCommand('copy');
    } catch (err) {
        console.error('Fallback: Could not copy text: ', err);
    }
    
    document.body.removeChild(textArea);
}

function extractAnalysisDataFromDOM() {
    // Extract source information
    const sourceElement = document.querySelector('.text-muted');
    const sourceText = sourceElement ? sourceElement.textContent.trim() : '';
    const isFile = sourceText.includes('File:');
    const sourceName = sourceText.replace(/^(File:|URL:)\s*/, '');
    
    // Extract GPU requirements from badges and text
    const minSection = document.querySelector('.border-warning');
    const optimalSection = document.querySelector('.border-success');
    
    // Extract quantities, VRAM, and runtime from text content
    const extractGpuInfo = (section) => {
        if (!section) return { type: '', quantity: 1, vram_gb: 0, runtime: '' };
        
        const text = section.textContent;
        const type = section.querySelector('.badge')?.textContent.trim() || '';
        const quantityMatch = text.match(/Quantity:\s*(\d+)/);
        const vramMatch = text.match(/VRAM:\s*(\d+)\s*GB/);
        const runtimeMatch = text.match(/Runtime:\s*(.{0,50}?)(?=\s|$)/);
        
        return {
            type: type,
            quantity: quantityMatch ? parseInt(quantityMatch[1]) : 1,
            vram_gb: vramMatch ? parseInt(vramMatch[1]) : 0,
            runtime: runtimeMatch ? runtimeMatch[1].trim() : ''
        };
    };
    
    const minGpu = extractGpuInfo(minSection);
    const optimalGpu = extractGpuInfo(optimalSection);
    
    // Extract technical details
    const sxmElement = Array.from(document.querySelectorAll('.small')).find(el => el.textContent.includes('SXM Required'));
    const sxmRequired = sxmElement ? sxmElement.textContent.includes('Yes') : false;
    
    const armElement = Array.from(document.querySelectorAll('.small')).find(el => el.textContent.includes('ARM Compatibility'));
    const armCompatibility = armElement ? 
        armElement.querySelector('.badge')?.textContent.trim() || 'Unknown' : 'Unknown';
    
    // Extract compliance score
    const complianceElement = document.querySelector('.compliance-score');
    const complianceText = complianceElement ? complianceElement.textContent.trim() : '0/100';
    const complianceScore = parseInt(complianceText.split('/')[0]) || 0;
    
    // Extract confidence
    const confidenceElements = document.querySelectorAll('.compliance-score');
    let confidence = 0;
    for (let elem of confidenceElements) {
        const text = elem.textContent.trim();
        if (text.includes('%')) {
            confidence = parseInt(text.replace('%', '')) || 0;
            break;
        }
    }
    
    // Check for LLM enhancement
    const enhancementBadge = Array.from(document.querySelectorAll('.badge')).find(el => el.textContent.includes('LLM'));
    const llmEnhanced = enhancementBadge ? enhancementBadge.textContent.includes('LLM') : false;
    
    // Extract reasoning items
    const reasoningItems = Array.from(document.querySelectorAll('.reasoning-item')).map(item => item.textContent.trim());
    const reasoning = reasoningItems.filter(item => !item.includes('LLM:'));
    const llmReasoning = reasoningItems.filter(item => item.includes('LLM:')).map(item => item.replace(/^LLM:\s*/, ''));
    
    return {
        source_name: sourceName,
        source_type: isFile ? 'file' : 'url',
        min_gpu: minGpu,
        optimal_gpu: optimalGpu,
        sxm_required: sxmRequired,
        arm_compatibility: armCompatibility,
        nvidia_compliance_score: complianceScore,
        confidence: confidence,
        llm_enhanced: llmEnhanced,
        reasoning: reasoning,
        llm_reasoning: llmReasoning
    };
}

function getArmCompatibilityBadge(compatibility) {
    if (compatibility.includes('Compatible')) {
        return `<span class="badge bg-success ms-1">${compatibility}</span>`;
    } else if (compatibility.includes('Likely')) {
        return `<span class="badge bg-warning ms-1">${compatibility}</span>`;
    } else {
        return `<span class="badge bg-danger ms-1">${compatibility}</span>`;
    }
}

function getComplianceClass(score) {
    if (score >= 90) return 'score-excellent';
    if (score >= 80) return 'score-good';
    if (score >= 70) return 'score-fair';
    if (score >= 60) return 'score-poor';
    return 'score-critical';
}

function renderComplianceDetails(analysis) {
    let html = '';
    
    if (analysis.structure_assessment) {
        html += '<h6 class="text-primary">Structure Assessment</h6>';
        for (const [key, value] of Object.entries(analysis.structure_assessment)) {
            html += `<div class="small mb-1"><strong>${key}:</strong> ${value}</div>`;
        }
    }
    
    if (analysis.content_quality_issues && analysis.content_quality_issues.length > 0) {
        html += '<h6 class="text-warning mt-3">Content Recommendations</h6>';
        analysis.content_quality_issues.forEach(issue => {
            html += `<div class="small mb-1">‚Ä¢ ${issue}</div>`;
        });
    }
    
    if (analysis.technical_recommendations && analysis.technical_recommendations.length > 0) {
        html += '<h6 class="text-info mt-3">Technical Recommendations</h6>';
        analysis.technical_recommendations.forEach(rec => {
            html += `<div class="small mb-1">‚Ä¢ ${rec}</div>`;
        });
    }
    
    return html || '<p class="text-muted">No detailed compliance information available.</p>';
}

function showError(message) {
    document.getElementById('errorMessage').textContent = message;
    document.getElementById('streamingError').classList.remove('d-none');
}
</script>

<style>
.compliance-score {
    font-size: 2rem;
    font-weight: bold;
    line-height: 1;
}

.score-excellent { color: #198754; }
.score-good { color: #76b900; }
.score-fair { color: #fd7e14; }
.score-poor { color: #dc3545; }
.score-critical { color: #6f42c1; }

.reasoning-item {
    padding: 0.25rem 0.5rem;
    margin: 0.1rem 0;
    background: #f8f9fa;
    border-left: 3px solid #76b900;
    border-radius: 0 0.25rem 0.25rem 0;
    font-size: 0.875rem;
}
</style>
{% endblock %} 