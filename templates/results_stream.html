{% extends "base.html" %}

{% block title %}Analysis Results - Notebook Analyzer{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div id="streamingResults" class="d-none">
        <!-- This will be populated by JavaScript when results arrive -->
    </div>
    
    <div id="streamingError" class="d-none">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="alert alert-danger">
                    <h5><i class="bi bi-exclamation-triangle me-2"></i>Analysis Failed</h5>
                    <p id="errorMessage"></p>
                    <a href="{{ url_for('index') }}" class="btn btn-outline-danger">
                        <i class="bi bi-arrow-left me-1"></i>Try Again
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Store analysis data globally for copy function
let globalAnalysisData = null;

document.addEventListener('DOMContentLoaded', function() {
    // Check if we have direct results from traditional form submission
    {% if direct_results and analysis_data %}
        const data = {
            analysis: {{ analysis_data.analysis | tojson }},
            source_name: "{{ analysis_data.source_name }}",
            source_type: "{{ analysis_data.source_type }}"
        };
        globalAnalysisData = data; // Store for copy function
        displayResults(data);
        return;
    {% endif %}
    
    // Get analysis results from sessionStorage (set by streaming interface)
    const resultsData = sessionStorage.getItem('analysisResults');
    if (resultsData) {
        try {
            const data = JSON.parse(resultsData);
            globalAnalysisData = data; // Store for copy function
            displayResults(data);
            sessionStorage.removeItem('analysisResults'); // Clean up
        } catch (e) {
            showError('Failed to parse analysis results');
        }
    } else {
        // Check if this is direct access to the results page
        {% if direct_access %}
            showFriendlyMessage();
        {% else %}
            showError('No analysis results found');
        {% endif %}
    }
});

function displayResults(data) {
    const container = document.getElementById('streamingResults');
    const analysis = data.analysis;
    const sourceName = data.source_name;
    const sourceType = data.source_type;
    
    container.innerHTML = `
        <div class="row">
            <div class="col-12">
                <!-- Header -->
                <div class="row mb-4">
                    <div class="col-12 col-lg-8">
                        <h2 class="text-nvidia mb-1">
                            <i class="bi bi-clipboard-data me-2"></i>
                            Analysis Results
                        </h2>
                        <p class="text-muted mb-0">
                            ${sourceType === 'file' ? 
                                `<i class="bi bi-file-earmark-code me-1"></i>File: ${sourceName}` :
                                `<i class="bi bi-link-45deg me-1"></i>URL: <a href="${sourceName}" target="_blank" class="text-decoration-none">${sourceName}</a>`
                            }
                        </p>
                    </div>
                    <div class="col-12 col-lg-4 mt-3 mt-lg-0">
                        <div class="d-flex gap-2 justify-content-lg-end">
                            <button id="copyResults" class="btn btn-outline-nvidia flex-fill flex-lg-grow-0" onclick="copyResultsToClipboard()">
                                <i class="bi bi-clipboard me-1"></i>
                                Copy Results
                            </button>
                            <a href="/" class="btn btn-outline-secondary flex-fill flex-lg-grow-0">
                                <i class="bi bi-arrow-left me-1"></i>
                                Analyze Another
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Main Results Grid -->
                <div class="row">
                    <!-- GPU Requirements -->
                    <div class="col-lg-8 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="bi bi-gpu-card me-2"></i>
                                    GPU Requirements
                                </h5>
                            </div>
                            <div class="card-body">
                                ${analysis.min_gpu && analysis.min_gpu.type === 'CPU-only' ? `
                                <div class="alert alert-info mb-3">
                                    <div class="d-flex align-items-center">
                                        <i class="bi bi-cpu fs-4 me-3 text-info"></i>
                                        <div>
                                            <h6 class="mb-1">CPU-Optimized Workload Detected</h6>
                                            <small class="mb-0">This notebook is designed for CPU execution and does not require GPU acceleration.</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="row justify-content-center">
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-body text-center">
                                                <i class="bi bi-cpu fs-1 text-info mb-3"></i>
                                                <h5 class="text-info mb-3">CPU-Only Configuration</h5>
                                                <div class="mb-2">
                                                    <strong>Processing:</strong> 
                                                    <span class="badge bg-info ms-1">CPU Optimized</span>
                                                </div>
                                                <div class="mb-2">
                                                    <strong>GPU Required:</strong> No
                                                </div>
                                                <div class="mb-2">
                                                    <strong>VRAM:</strong> 0 GB
                                                </div>
                                                <div class="mb-0">
                                                    <strong>Estimated Runtime:</strong> 
                                                    <span class="text-muted">${analysis.min_gpu.runtime}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                ` : `
                                <div class="row">
                                    <!-- Minimum Configuration -->
                                    ${getMinimumColumn(analysis)}

                                    <!-- Recommended Configuration -->
                                    ${getRecommendedColumn(analysis)}

                                    <!-- Optimal Configuration -->
                                    ${getOptimalColumn(analysis)}
                                </div>
                                `}

                                <!-- Additional Requirements -->
                                <div class="row mt-3">
                                    <div class="col-md-6">
                                        <div class="small">
                                            <strong>SXM Required:</strong>
                                            ${analysis.sxm_required ? 
                                                '<span class="badge bg-info ms-1">Yes</span>' :
                                                '<span class="badge bg-secondary ms-1">No</span>'
                                            }
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="small">
                                            <strong>ARM Compatibility:</strong>
                                            ${getArmCompatibilityBadge(analysis.arm_compatibility)}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Compliance & Confidence -->
                    <div class="col-lg-4 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="bi bi-speedometer2 me-2"></i>
                                    Assessment Metrics
                                </h6>
                            </div>
                            <div class="card-body text-center">
                                <!-- Compliance Score -->
                                <div class="mb-3">
                                    <div class="compliance-score ${getComplianceClass(analysis.nvidia_compliance_score)}">
                                        ${analysis.nvidia_compliance_score}/100
                                    </div>
                                    <small class="text-muted">NVIDIA Compliance Score</small>
                                </div>

                                <!-- Confidence -->
                                <div class="mb-3">
                                    <div class="compliance-score text-primary">
                                        ${analysis.confidence}%
                                    </div>
                                    <small class="text-muted">Analysis Confidence</small>
                                </div>

                                <!-- Enhancement Status -->
                                <div class="d-flex flex-column gap-1">
                                    ${analysis.llm_enhanced ?
                                        '<span class="badge bg-nvidia"><i class="bi bi-robot me-1"></i>AI Enhanced</span>' :
                                        '<span class="badge bg-secondary"><i class="bi bi-gear me-1"></i>Static Analysis</span>'
                                    }
                                    ${analysis.self_reviewed ?
                                        '<span class="badge bg-success"><i class="bi bi-check2-circle me-1"></i>Self-Reviewed</span>' :
                                        ''
                                    }
                                    ${analysis.llm_model_used ?
                                        `<span class="badge bg-info text-dark"><i class="bi bi-cpu me-1"></i>${analysis.llm_model_used}</span>` :
                                        ''
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Detailed Analysis -->
                <div class="row">
                    <!-- Reasoning -->
                    <div class="col-lg-6 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0">
                                        <i class="bi bi-lightbulb me-2"></i>
                                        Analysis Reasoning
                                    </h6>
                                    <button class="btn btn-sm btn-outline-info" type="button" data-bs-toggle="collapse" data-bs-target="#methodologyCollapse" aria-expanded="false" aria-controls="methodologyCollapse">
                                        <i class="bi bi-info-circle me-1"></i>
                                        How it works
                                    </button>
                                </div>
                                <div class="collapse mt-3" id="methodologyCollapse">
                                    <div class="methodology-panel">
                                        <h6 class="methodology-heading">
                                            <i class="bi bi-gear me-1"></i>
                                            Analysis Methodology
                                        </h6>
                                        <p class="mb-2">
                                            <strong>Three-Stage Analysis:</strong> Our analyzer uses a comprehensive approach combining static pattern detection, AI enhancement, and self-review validation.
                                        </p>
                                        <hr class="methodology-divider">
                                        <ul class="mb-2 small methodology-list">
                                            <li><strong>Static Analysis:</strong> Scans code for GPU frameworks, model patterns, and workload indicators</li>
                                            <li><strong>AI Enhancement:</strong> Uses LLM to understand context, model complexity, and optimization techniques</li>
                                            <li><strong>Self-Review:</strong> AI acts as a "teacher grading its work" to identify inconsistencies and ensure recommendations are logical and bounded</li>
                                            <li><strong>Confidence Scoring:</strong> Combines pattern certainty with LLM agreement for overall confidence</li>
                                        </ul>
                                        <div class="small confidence-indicators">
                                            <i class="bi bi-check-circle-fill text-success me-1"></i> High confidence: Clear patterns detected
                                            <br>
                                            <i class="bi bi-check-circle text-warning me-1"></i> Medium confidence: Partial indicators found
                                            <br>
                                            <i class="bi bi-question-circle confidence-low-icon me-1"></i> Low confidence: Estimated or uncertain
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                ${getReasoningContent(analysis)}
                            </div>
                        </div>
                    </div>

                    <!-- Compliance Details -->
                    <div class="col-lg-6 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="bi bi-shield-check me-2"></i>
                                    NVIDIA Compliance
                                </h6>
                            </div>
                            <div class="card-body">
                                ${renderComplianceDetails(analysis)}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- API Access Section -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="bi bi-code-slash me-2"></i>
                            API Access
                        </h6>
                        <button id="copyCurlBtn" class="btn btn-sm btn-outline-nvidia" onclick="copyCurlCommand()">
                            <i class="bi bi-clipboard me-1"></i>
                            Copy curl
                        </button>
                    </div>
                    <div class="card-body">
                        <p class="text-muted mb-3">
                            <i class="bi bi-info-circle me-1"></i>
                            Reproduce this analysis programmatically using the API endpoint:
                        </p>
                        
                        ${getCurlCommand(sourceName, sourceType)}
                        
                        <!-- Actual API Response -->
                        <div class="mt-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="text-nvidia mb-0">
                                    <i class="bi bi-braces me-1"></i>
                                    Actual API Response
                                </h6>
                                <button id="copyApiBtn" class="btn btn-sm btn-outline-nvidia" onclick="copyApiResponse()">
                                    <i class="bi bi-clipboard me-1"></i>
                                    Copy JSON
                                </button>
                            </div>
                            <div class="bg-dark text-light p-3 rounded" style="background-color: #212529 !important; color: #f8f9fa !important;">
                                <div class="text-success mb-2" style="color: #198754 !important;">
                                    # This is the actual response for your analysis
                                </div>
                                <code id="apiResponse" class="text-light small" style="font-family: 'Courier New', monospace; color: #f8f9fa !important;">
                                    <!-- Will be populated by JavaScript -->
                                </code>
                            </div>
                            <div class="small text-muted mt-2">
                                <i class="bi bi-info-circle me-1"></i>
                                Note: Some arrays truncated for display. Copy JSON for complete data.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    container.classList.remove('d-none');
    
    // Initialize collapsible sections
    setTimeout(initializeCollapsibleSections, 100);
    
    // Populate the API response after results are displayed
    if (globalAnalysisData) {
        populateApiResponse(globalAnalysisData);
    }
}

function populateApiResponse(data) {
    const apiResponseElement = document.getElementById('apiResponse');
    if (apiResponseElement) {
        // Generate the actual API response JSON
        const apiResponse = generateApiResponse(data);
        apiResponseElement.innerHTML = apiResponse;
    }
}

function generateApiResponse(data) {
    const analysis = data.analysis;
    
    // Create truncated display version for readability
    const displayResponse = {
        success: true,
        source_type: data.source_type,
        source_name: data.source_name,
        analysis: {
            min_gpu: {
                type: analysis.min_gpu.type,
                quantity: analysis.min_gpu.quantity,
                vram_gb: analysis.min_gpu.vram_gb,
                runtime: analysis.min_gpu.runtime
            },
            recommended_gpu: (analysis.recommended_viable && analysis.recommended_gpu) ? {
                type: analysis.recommended_gpu.type,
                quantity: analysis.recommended_gpu.quantity,
                vram_gb: analysis.recommended_gpu.vram_gb,
                runtime: analysis.recommended_gpu.runtime
            } : null,
            consumer_gpu: (analysis.consumer_viable && analysis.consumer_gpu) ? {
                type: analysis.consumer_gpu.type,
                quantity: analysis.consumer_gpu.quantity,
                vram_gb: analysis.consumer_gpu.vram_gb,
                runtime: analysis.consumer_gpu.runtime
            } : null,
            recommended_viable: analysis.recommended_viable,
            recommended_limitation: analysis.recommended_limitation,
            consumer_viable: analysis.consumer_viable,
            consumer_limitation: analysis.consumer_limitation,
            optimal_gpu: {
                type: analysis.optimal_gpu.type,
                quantity: analysis.optimal_gpu.quantity,
                vram_gb: analysis.optimal_gpu.vram_gb,
                runtime: analysis.optimal_gpu.runtime
            },
            enterprise_gpu: {
                type: analysis.enterprise_gpu.type,
                quantity: analysis.enterprise_gpu.quantity,
                vram_gb: analysis.enterprise_gpu.vram_gb,
                runtime: analysis.enterprise_gpu.runtime
            },
            confidence: analysis.confidence,
            nvidia_compliance_score: analysis.nvidia_compliance_score,
            sxm_required: analysis.sxm_required,
            arm_compatibility: analysis.arm_compatibility,
            llm_enhanced: analysis.llm_enhanced,
            llm_model_used: analysis.llm_model_used,
            reasoning: analysis.reasoning ? analysis.reasoning.slice(0, 3) : [], // First 3 items
            llm_reasoning: analysis.llm_reasoning ? analysis.llm_reasoning.slice(0, 2) : [], // First 2 items
            structure_assessment: analysis.structure_assessment,
            content_quality_issues: analysis.content_quality_issues ? analysis.content_quality_issues.slice(0, 3) : [],
            technical_recommendations: analysis.technical_recommendations ? analysis.technical_recommendations.slice(0, 3) : []
        }
    };
    
    return JSON.stringify(displayResponse, null, 2)
        .replace(/\n/g, '<br>')
        .replace(/  /g, '&nbsp;&nbsp;');
}

function copyApiResponse() {
    const copyBtn = document.getElementById('copyApiBtn');
    const originalText = copyBtn.innerHTML;
    
    try {
        if (!globalAnalysisData) {
            throw new Error('No analysis data available');
        }
        
        // Create complete response for copying (not truncated)
        const completeResponse = {
            success: true,
            source_type: globalAnalysisData.source_type,
            source_name: globalAnalysisData.source_name,
            analysis: globalAnalysisData.analysis
        };
        
        const jsonString = JSON.stringify(completeResponse, null, 2);
        
        // Copy to clipboard
        navigator.clipboard.writeText(jsonString).then(() => {
            copyBtn.innerHTML = '<i class="bi bi-check-circle me-1"></i>Copied!';
            copyBtn.classList.remove('btn-outline-nvidia');
            copyBtn.classList.add('btn-success');
            
            setTimeout(() => {
                copyBtn.innerHTML = originalText;
                copyBtn.classList.remove('btn-success');
                copyBtn.classList.add('btn-outline-nvidia');
            }, 2000);
        }).catch(err => {
            // Fallback
            fallbackCopyTextToClipboard(jsonString);
            copyBtn.innerHTML = '<i class="bi bi-check-circle me-1"></i>Copied!';
            copyBtn.classList.remove('btn-outline-nvidia');
            copyBtn.classList.add('btn-success');
            
            setTimeout(() => {
                copyBtn.innerHTML = originalText;
                copyBtn.classList.remove('btn-success');
                copyBtn.classList.add('btn-outline-nvidia');
            }, 2000);
        });
    } catch (err) {
        console.error('Error copying API response:', err);
        copyBtn.innerHTML = '<i class="bi bi-exclamation-triangle me-1"></i>Error';
        copyBtn.classList.remove('btn-outline-nvidia');
        copyBtn.classList.add('btn-danger');
        
        setTimeout(() => {
            copyBtn.innerHTML = originalText;
            copyBtn.classList.remove('btn-danger');
            copyBtn.classList.add('btn-outline-nvidia');
        }, 2000);
    }
}

function copyResultsToClipboard() {
    const copyBtn = document.getElementById('copyResults');
    const originalText = copyBtn.innerHTML;
    
    try {
        let formattedText;
        
        // Use global analysis data (sessionStorage is cleared after display)
        if (!globalAnalysisData) {
            // Fallback: try to extract from DOM like the regular results page
            const analysisData = extractAnalysisDataFromDOM();
            formattedText = createShareableText(analysisData, analysisData.source_name, analysisData.source_type);
        } else {
            // Create formatted text for sharing
            formattedText = createShareableText(globalAnalysisData.analysis, globalAnalysisData.source_name, globalAnalysisData.source_type);
        }
        
        // Copy to clipboard
        navigator.clipboard.writeText(formattedText).then(() => {
            showCopySuccess(copyBtn, originalText);
        }).catch(err => {
            // Fallback for older browsers
            fallbackCopyTextToClipboard(formattedText);
            showCopySuccess(copyBtn, originalText);
        });
    } catch (err) {
        console.error('Error copying results:', err);
        showCopyError(copyBtn, originalText);
    }
}

function createShareableText(analysis, sourceName, sourceType) {
    const sourceInfo = sourceType === 'file' ? 
        `üìÑ File: ${sourceName}` : 
        `üîó URL: ${sourceName}`;
    
    // Check if this is a CPU-only workload
    const isCpuOnly = analysis.min_gpu.type === 'CPU-only' || 
                      (analysis.min_gpu.type && analysis.min_gpu.type.includes('CPU-only'));
    
    let text = `üöÄ **GPU Analysis Results**
${sourceInfo}

`;

    if (isCpuOnly) {
        // Simplified CPU-only format matching CLI behavior
        text += `**üíª CPU-OPTIMIZED WORKLOAD:**
This notebook is designed for CPU execution and does not require GPU acceleration.

‚Ä¢ GPU Required: No
‚Ä¢ Estimated Runtime: ${analysis.min_gpu.runtime}
‚Ä¢ Processing: CPU-Only

**üìä Technical Details:**
‚Ä¢ SXM Required: No
‚Ä¢ ARM Compatibility: ${analysis.arm_compatibility}
‚Ä¢ NVIDIA Compliance: ${analysis.nvidia_compliance_score}/100
‚Ä¢ Analysis Confidence: ${analysis.confidence}%
‚Ä¢ Enhancement: ${analysis.llm_enhanced ? 'LLM Enhanced' : 'Static Analysis'}${analysis.llm_model_used ? `\n‚Ä¢ AI Model: ${analysis.llm_model_used}` : ''}`;
    } else {
        // Full 3-tier format for GPU workloads
        text += `**üíæ Minimum Configuration:**
‚Ä¢ GPU: ${analysis.min_gpu.type}
‚Ä¢ Quantity: ${analysis.min_gpu.quantity}
‚Ä¢ VRAM: ${analysis.min_gpu.vram_gb} GB
‚Ä¢ Runtime: ${analysis.min_gpu.runtime}

**üéØ Recommended:**`;

        // Handle recommended tier
        if (!analysis.consumer_gpu || analysis.consumer_gpu.type === 'CPU-only') {
            text += `
‚Ä¢ Processing: CPU-Only
‚Ä¢ GPU Required: No
‚Ä¢ VRAM: 0 GB
‚Ä¢ Runtime: CPU execution`;
        } else if (analysis.consumer_gpu) {
            text += `
‚Ä¢ GPU: ${analysis.consumer_gpu.type}
‚Ä¢ Quantity: ${analysis.consumer_gpu.quantity}
‚Ä¢ VRAM: ${analysis.consumer_gpu.vram_gb} GB
‚Ä¢ Runtime: ${analysis.consumer_gpu.runtime}`;
            
            // Add limitation note only for actual GPU workloads that have limitations
            if (!analysis.consumer_viable && analysis.consumer_limitation) {
                text += `\n‚Ä¢ Note: ${analysis.consumer_limitation}`;
            }
        } else {
            text += `
‚Ä¢ Not Recommended${analysis.consumer_limitation ? '\n‚Ä¢ Reason: ' + analysis.consumer_limitation : ''}`;
        }

        text += `

**‚≠ê Optimal:**
‚Ä¢ GPU: ${analysis.enterprise_gpu && analysis.enterprise_gpu.type ? analysis.enterprise_gpu.type : 'CPU-only'}
‚Ä¢ Quantity: ${analysis.enterprise_gpu ? analysis.enterprise_gpu.quantity : 0}
‚Ä¢ VRAM: ${analysis.enterprise_gpu ? analysis.enterprise_gpu.vram_gb : 0} GB
‚Ä¢ Runtime: ${analysis.enterprise_gpu && analysis.enterprise_gpu.runtime ? analysis.enterprise_gpu.runtime : 'CPU execution'}

**üìä Technical Details:**
‚Ä¢ SXM Required: ${analysis.sxm_required ? 'Yes' : 'No'}
‚Ä¢ ARM Compatibility: ${analysis.arm_compatibility}
‚Ä¢ NVIDIA Compliance: ${analysis.nvidia_compliance_score}/100
‚Ä¢ Analysis Confidence: ${analysis.confidence}%
‚Ä¢ Enhancement: ${analysis.llm_enhanced ? 'LLM Enhanced' : 'Static Analysis'}${analysis.llm_model_used ? `\n‚Ä¢ AI Model: ${analysis.llm_model_used}` : ''}`;
    }

    // Add LLM insights first if available (Phase 1: Prioritize LLM)
    if (analysis.llm_reasoning && analysis.llm_reasoning.length > 0) {
        text += `\n\n**ü§ñ AI Enhanced Analysis:**`;
        analysis.llm_reasoning.slice(0, 3).forEach(reason => {
            text += `\n‚Ä¢ ${reason}`;
        });
    }

    // Add static analysis points second
    if (analysis.reasoning && analysis.reasoning.length > 0) {
        const title = analysis.llm_reasoning && analysis.llm_reasoning.length > 0 ? 
            'Static Analysis Details' : 'Key Analysis Points';
        text += `\n\n**üîç ${title}:**`;
        
        // Remove duplicates and limit to 5 items
        const uniqueReasons = [...new Set(analysis.reasoning)];
        uniqueReasons.slice(0, 5).forEach(reason => {
            text += `\n‚Ä¢ ${reason}`;
        });
    }

    text += `\n\n---\nüìù Analysis generated by Notebook Analyzer`;
    
    return text;
}

function showCopySuccess(copyBtn, originalText) {
    copyBtn.innerHTML = '<i class="bi bi-check-circle me-1"></i>Copied!';
    copyBtn.classList.remove('btn-outline-nvidia');
    copyBtn.classList.add('btn-success');
    
    setTimeout(() => {
        copyBtn.innerHTML = originalText;
        copyBtn.classList.remove('btn-success');
        copyBtn.classList.add('btn-outline-nvidia');
    }, 2000);
}

function showCopyError(copyBtn, originalText) {
    copyBtn.innerHTML = '<i class="bi bi-exclamation-triangle me-1"></i>Error';
    copyBtn.classList.remove('btn-outline-nvidia');
    copyBtn.classList.add('btn-danger');
    
    setTimeout(() => {
        copyBtn.innerHTML = originalText;
        copyBtn.classList.remove('btn-danger');
        copyBtn.classList.add('btn-outline-nvidia');
    }, 2000);
}

function fallbackCopyTextToClipboard(text) {
    const textArea = document.createElement("textarea");
    textArea.value = text;
    textArea.style.position = "fixed";
    textArea.style.top = "0";
    textArea.style.left = "0";
    
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
        document.execCommand('copy');
    } catch (err) {
        console.error('Fallback: Could not copy text: ', err);
    }
    
    document.body.removeChild(textArea);
}

function getCurlCommand(sourceName, sourceType) {
    const baseUrl = window.location.origin;
    
    if (sourceType === 'file') {
        return `
            <div class="bg-dark text-light p-3 rounded mb-3" style="background-color: #212529 !important; color: #f8f9fa !important; font-family: 'Courier New', monospace;">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <div class="text-success mb-2" style="color: #198754 !important;"># Analyze uploaded file</div>
                        <div id="curlCommand" class="text-break">curl -X POST "${baseUrl}/api/analyze" \\<br>
&nbsp;&nbsp;&nbsp;&nbsp;-F "file=@${sourceName}"</div>
                    </div>
                </div>
            </div>
            
            <div class="bg-dark text-light p-3 rounded" style="background-color: #212529 !important; color: #f8f9fa !important;">
                <div class="text-success mb-2" style="color: #198754 !important;">
                    # For URL analysis, use JSON payload
                </div>
                <code class="text-light" style="font-family: 'Courier New', monospace; color: #f8f9fa !important;">
                    curl -X POST "${baseUrl}/api/analyze" \\<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;-H "Content-Type: application/json" \\<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;-d '{"url": "https://example.com/notebook.ipynb"}'
                </code>
            </div>
        `;
    } else {
        return `
            <div class="bg-dark text-light p-3 rounded mb-3" style="background-color: #212529 !important; color: #f8f9fa !important; font-family: 'Courier New', monospace;">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <div class="text-success mb-2" style="color: #198754 !important;"># Analyze from URL</div>
                        <div id="curlCommand" class="text-break">curl -X POST "${baseUrl}/api/analyze" \\<br>
&nbsp;&nbsp;&nbsp;&nbsp;-H "Content-Type: application/json" \\<br>
&nbsp;&nbsp;&nbsp;&nbsp;-d '{"url": "${sourceName.replace(/"/g, '\\"')}"}'</div>
                    </div>
                </div>
            </div>
            
            <div class="bg-dark text-light p-3 rounded" style="background-color: #212529 !important; color: #f8f9fa !important;">
                <div class="text-success mb-2" style="color: #198754 !important;">
                    # For file uploads, use multipart/form-data
                </div>
                <code class="text-light" style="font-family: 'Courier New', monospace; color: #f8f9fa !important;">
                    curl -X POST "${baseUrl}/api/analyze" \\<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;-F "file=@/path/to/notebook.ipynb"
                </code>
            </div>
        `;
    }
}

function copyCurlCommand() {
    const copyBtn = document.getElementById('copyCurlBtn');
    const originalText = copyBtn.innerHTML;
    
    try {
        // Get the curl command text from the DOM
        const curlCommandElement = document.getElementById('curlCommand');
        if (!curlCommandElement) {
            console.error('Could not find curl command element');
            return;
        }
        
        // Extract the curl command text and clean it up
        let curlCommand = curlCommandElement.textContent || curlCommandElement.innerText;
        
        // Clean up the command by removing HTML entities and extra whitespace
        curlCommand = curlCommand
            .replace(/&nbsp;/g, ' ')           // Replace HTML non-breaking spaces
            .replace(/\s+/g, ' ')             // Replace multiple spaces with single space
            .replace(/\\\s+/g, ' \\\n  ')     // Format line continuations properly
            .trim();                          // Remove leading/trailing whitespace
        
        // Copy to clipboard
        navigator.clipboard.writeText(curlCommand).then(() => {
            // Success feedback
            copyBtn.innerHTML = '<i class="bi bi-check-circle me-1"></i>Copied!';
            copyBtn.classList.remove('btn-outline-nvidia');
            copyBtn.classList.add('btn-success');
            
            // Reset button after 2 seconds
            setTimeout(() => {
                copyBtn.innerHTML = originalText;
                copyBtn.classList.remove('btn-success');
                copyBtn.classList.add('btn-outline-nvidia');
            }, 2000);
        }).catch(err => {
            // Fallback for older browsers
            fallbackCopyTextToClipboard(curlCommand);
            
            // Show success feedback even for fallback
            copyBtn.innerHTML = '<i class="bi bi-check-circle me-1"></i>Copied!';
            copyBtn.classList.remove('btn-outline-nvidia');
            copyBtn.classList.add('btn-success');
            
            setTimeout(() => {
                copyBtn.innerHTML = originalText;
                copyBtn.classList.remove('btn-success');
                copyBtn.classList.add('btn-outline-nvidia');
            }, 2000);
        });
    } catch (err) {
        console.error('Error copying curl command:', err);
        
        // Show error feedback
        copyBtn.innerHTML = '<i class="bi bi-exclamation-triangle me-1"></i>Error';
        copyBtn.classList.remove('btn-outline-nvidia');
        copyBtn.classList.add('btn-danger');
        
        setTimeout(() => {
            copyBtn.innerHTML = originalText;
            copyBtn.classList.remove('btn-danger');
            copyBtn.classList.add('btn-outline-nvidia');
        }, 2000);
    }
}

function extractAnalysisDataFromDOM() {
    // Extract source information
    const sourceElement = document.querySelector('.text-muted');
    const sourceText = sourceElement ? sourceElement.textContent.trim() : '';
    const isFile = sourceText.includes('File:');
    const sourceName = sourceText.replace(/^(File:|URL:)\s*/, '');
    
    // Extract GPU requirements from badges and text
    const minSection = document.querySelector('.border-warning');
    const optimalSection = document.querySelector('.border-success');
    
    // Extract quantities, VRAM, and runtime from text content
    const extractGpuInfo = (section) => {
        if (!section) return { type: '', quantity: 1, vram_gb: 0, runtime: '' };
        
        const text = section.textContent;
        const type = section.querySelector('.badge')?.textContent.trim() || '';
        const quantityMatch = text.match(/Quantity:\s*(\d+)/);
        const vramMatch = text.match(/VRAM:\s*(\d+)\s*GB/);
        const runtimeMatch = text.match(/Runtime:\s*(.{0,50}?)(?=\s|$)/);
        
        return {
            type: type,
            quantity: quantityMatch ? parseInt(quantityMatch[1]) : 1,
            vram_gb: vramMatch ? parseInt(vramMatch[1]) : 0,
            runtime: runtimeMatch ? runtimeMatch[1].trim() : ''
        };
    };
    
    const minGpu = extractGpuInfo(minSection);
    const optimalGpu = extractGpuInfo(optimalSection);
    
    // Extract technical details
    const sxmElement = Array.from(document.querySelectorAll('.small')).find(el => el.textContent.includes('SXM Required'));
    const sxmRequired = sxmElement ? sxmElement.textContent.includes('Yes') : false;
    
    const armElement = Array.from(document.querySelectorAll('.small')).find(el => el.textContent.includes('ARM Compatibility'));
    const armCompatibility = armElement ? 
        armElement.querySelector('.badge')?.textContent.trim() || 'Unknown' : 'Unknown';
    
    // Extract compliance score
    const complianceElement = document.querySelector('.compliance-score');
    const complianceText = complianceElement ? complianceElement.textContent.trim() : '0/100';
    const complianceScore = parseInt(complianceText.split('/')[0]) || 0;
    
    // Extract confidence
    const confidenceElements = document.querySelectorAll('.compliance-score');
    let confidence = 0;
    for (let elem of confidenceElements) {
        const text = elem.textContent.trim();
        if (text.includes('%')) {
            confidence = parseInt(text.replace('%', '')) || 0;
            break;
        }
    }
    
    // Check for LLM enhancement
    const enhancementBadge = Array.from(document.querySelectorAll('.badge')).find(el => el.textContent.includes('LLM'));
    const llmEnhanced = enhancementBadge ? enhancementBadge.textContent.includes('LLM') : false;
    
    // Extract reasoning items
    const reasoningItems = Array.from(document.querySelectorAll('.reasoning-item')).map(item => item.textContent.trim());
    const reasoning = reasoningItems.filter(item => !item.includes('LLM:'));
    const llmReasoning = reasoningItems.filter(item => item.includes('LLM:')).map(item => item.replace(/^LLM:\s*/, ''));
    
    return {
        source_name: sourceName,
        source_type: isFile ? 'file' : 'url',
        min_gpu: minGpu,
        optimal_gpu: optimalGpu,
        sxm_required: sxmRequired,
        arm_compatibility: armCompatibility,
        nvidia_compliance_score: complianceScore,
        confidence: confidence,
        llm_enhanced: llmEnhanced,
        reasoning: reasoning,
        llm_reasoning: llmReasoning
    };
}

function getReasoningContent(analysis) {
    const hasLLM = analysis.llm_reasoning && analysis.llm_reasoning.length > 0;
    const hasStatic = analysis.reasoning && analysis.reasoning.length > 0;
    
    if (!hasLLM && !hasStatic) {
        return '<p class="text-muted">No reasoning information available.</p>';
    }
    
    // Detect conflicts between static and LLM analysis
    const hasConflict = detectAnalysisConflict(analysis);
    
    let content = '';
    
    // Show LLM analysis first when available (Phase 1: Prioritize LLM)
    if (hasLLM) {
        content += `
            <div class="analysis-section primary-analysis">
                <div class="d-flex align-items-center mb-2">
                                         <h6 class="text-nvidia mb-0 me-2">
                         <i class="bi bi-robot me-1"></i>
                         AI Enhanced Analysis
                     </h6>
                    <span class="badge bg-nvidia">Primary</span>
                    ${hasConflict ? '<i class="bi bi-exclamation-triangle text-warning ms-2" title="Conflicts detected with static analysis"></i>' : ''}
                </div>
                ${analysis.llm_reasoning.map(reason => 
                    `<div class="reasoning-item llm-reasoning">${addConfidenceIndicator(reason, 'high')}</div>`
                ).join('')}
            </div>
        `;
    }
    
    // Show static analysis second, with appropriate styling
    if (hasStatic) {
        const staticTitle = hasLLM ? 'Static Analysis Details' : 'Analysis Details';
        const staticBadge = hasLLM ? '<span class="badge bg-secondary ms-2">Fallback</span>' : '';
        const conflictWarning = hasConflict ? `
            <div class="alert alert-warning py-2 px-3 mb-2 small">
                <i class="bi bi-info-circle me-1"></i>
                Note: Some static analysis points may be less accurate than AI analysis above.
            </div>
        ` : '';
        
        const isCollapsible = hasLLM; // Make static analysis collapsible when LLM is available
        const collapseId = 'staticAnalysisCollapse';
        
        content += `
            <div class="analysis-section ${hasLLM ? 'secondary-analysis mt-3' : 'primary-analysis'}">
                <div class="d-flex align-items-center mb-2">
                    <h6 class="mb-0 me-2 ${hasLLM ? 'text-muted' : 'text-primary'}">
                        <i class="bi bi-gear me-1"></i>
                        ${staticTitle}
                    </h6>
                    ${staticBadge}
                    ${isCollapsible ? `
                        <button class="btn btn-sm btn-outline-secondary ms-auto" type="button" data-bs-toggle="collapse" data-bs-target="#${collapseId}" aria-expanded="false" aria-controls="${collapseId}">
                            <i class="bi bi-chevron-down"></i>
                            <span class="collapse-text">Show Details</span>
                        </button>
                    ` : ''}
                </div>
                ${conflictWarning}
                <div class="${isCollapsible ? 'collapse' : ''}" id="${isCollapsible ? collapseId : ''}">
                    ${analysis.reasoning.map(reason => 
                        `<div class="reasoning-item ${hasLLM ? 'static-reasoning' : ''}">${addConfidenceIndicator(reason, hasLLM ? 'medium' : 'high')}</div>`
                    ).join('')}
                </div>
            </div>
        `;
    }
    
    return content;
}

function detectAnalysisConflict(analysis) {
    const hasLLM = analysis.llm_reasoning && analysis.llm_reasoning.length > 0;
    const hasStatic = analysis.reasoning && analysis.reasoning.length > 0;
    
    if (!hasLLM || !hasStatic) {
        return false;
    }
    
    // Check for common conflict patterns
    const staticText = analysis.reasoning.join(' ').toLowerCase();
    const llmText = analysis.llm_reasoning.join(' ').toLowerCase();
    
    // Detect CPU vs GPU conflicts
    const staticSaysCPU = staticText.includes('cpu-only') || staticText.includes('no gpu');
    const staticSaysGPU = staticText.includes('gpu') && !staticText.includes('no gpu');
    const llmSaysCPU = llmText.includes('cpu-only') || llmText.includes('no gpu');
    const llmSaysGPU = llmText.includes('gpu') && !llmText.includes('no gpu');
    
    // Conflict if one says CPU and other says GPU
    if ((staticSaysCPU && llmSaysGPU) || (staticSaysGPU && llmSaysCPU)) {
        return true;
    }
    
    // Check for contradictory VRAM estimates (basic heuristic)
    const staticVRAM = extractVRAMFromText(staticText);
    const llmVRAM = extractVRAMFromText(llmText);
    
    if (staticVRAM > 0 && llmVRAM > 0) {
        // Conflict if estimates differ by more than 50%
        const ratio = Math.max(staticVRAM, llmVRAM) / Math.min(staticVRAM, llmVRAM);
        if (ratio > 1.5) {
            return true;
        }
    }
    
    return false;
}

function extractVRAMFromText(text) {
    const vramMatch = text.match(/(\d+)\s*gb/i);
    return vramMatch ? parseInt(vramMatch[1]) : 0;
}

function getRecommendedColumn(analysis) {
    // Handle CPU-only workloads where consumer_gpu is null
    if (!analysis.consumer_gpu || analysis.consumer_gpu.type === 'CPU-only') {
        return `
            <div class="col-md-4 mb-3">
                <div class="border-start border-info border-3 ps-3">
                    <h6 class="text-info mb-2">
                        <i class="bi bi-cpu me-1"></i>
                        CPU-Only
                    </h6>
                    <div class="mb-2">
                        <strong>Processing:</strong> 
                        <span class="badge bg-info ms-1">CPU Optimized</span>
                    </div>
                    <div class="mb-2">
                        <strong>GPU Required:</strong> No
                    </div>
                    <div class="mb-2">
                        <strong>VRAM:</strong> 0 GB
                    </div>
                                                <div class="mb-0">
                                <strong>Runtime:</strong> 
                                <span class="text-muted">CPU execution</span>
                            </div>
                </div>
            </div>
        `;
    }
    
    // With the 3-tier system, there should always be a recommended GPU for any GPU workload
    return `
        <div class="col-md-4 mb-3">
            <div class="border-start border-primary border-3 ps-3">
                <h6 class="text-primary mb-2">
                    <i class="bi bi-award me-1"></i>
                    Recommended
                </h6>
                <div class="mb-2">
                    <strong>GPU:</strong> 
                    <span class="badge bg-primary ms-1">${analysis.consumer_gpu.type}</span>
                </div>
                <div class="mb-2">
                    <strong>Quantity:</strong> ${analysis.consumer_gpu.quantity}
                </div>
                <div class="mb-2">
                    <strong>VRAM:</strong> ${analysis.consumer_gpu.vram_gb} GB
                </div>
                <div class="mb-0">
                    <strong>Runtime:</strong> 
                    <span class="text-muted">${analysis.consumer_gpu.runtime}</span>
                </div>
                ${!analysis.consumer_viable && analysis.consumer_limitation && analysis.consumer_gpu.type !== 'CPU-only' ? `
                <div class="small text-muted mt-2">
                    <i class="bi bi-info-circle me-1"></i>
                    ${analysis.consumer_limitation}
                </div>
                ` : ''}
            </div>
        </div>
    `;
}

function getMinimumColumn(analysis) {
    // Handle CPU-only workloads
    if (analysis.min_gpu.type === 'CPU-only') {
        return `
            <div class="col-md-4 mb-3">
                <div class="border-start border-info border-3 ps-3">
                    <h6 class="text-info mb-2">
                        <i class="bi bi-cpu me-1"></i>
                        CPU-Only
                    </h6>
                    <div class="mb-2">
                        <strong>Processing:</strong> 
                        <span class="badge bg-info ms-1">CPU Optimized</span>
                    </div>
                    <div class="mb-2">
                        <strong>GPU Required:</strong> No
                    </div>
                    <div class="mb-2">
                        <strong>VRAM:</strong> 0 GB
                    </div>
                    <div class="mb-0">
                        <strong>Runtime:</strong> 
                        <span class="text-muted">${analysis.min_gpu.runtime}</span>
                    </div>
                </div>
            </div>
        `;
    }
    
    // Regular GPU workload
    return `
        <div class="col-md-4 mb-3">
            <div class="border-start border-warning border-3 ps-3">
                <h6 class="text-warning mb-2">
                    <i class="bi bi-shield-fill-exclamation me-1"></i>
                    Minimum
                </h6>
                <div class="mb-2">
                    <strong>GPU:</strong> 
                    <span class="badge bg-warning text-dark ms-1">${analysis.min_gpu.type}</span>
                </div>
                <div class="mb-2">
                    <strong>Quantity:</strong> ${analysis.min_gpu.quantity}
                </div>
                <div class="mb-2">
                    <strong>VRAM:</strong> ${analysis.min_gpu.vram_gb} GB
                </div>
                <div class="mb-0">
                    <strong>Runtime:</strong> 
                    <span class="text-muted">${analysis.min_gpu.runtime}</span>
                </div>
            </div>
        </div>
    `;
}

function getOptimalColumn(analysis) {
    // Handle CPU-only workloads
    if (!analysis.enterprise_gpu || analysis.enterprise_gpu.type === '' || analysis.enterprise_gpu.type === 'CPU-only') {
        return `
            <div class="col-md-4 mb-3">
                <div class="border-start border-info border-3 ps-3">
                    <h6 class="text-info mb-2">
                        <i class="bi bi-cpu me-1"></i>
                        CPU-Only
                    </h6>
                    <div class="mb-2">
                        <strong>Processing:</strong> 
                        <span class="badge bg-info ms-1">CPU Optimized</span>
                    </div>
                    <div class="mb-2">
                        <strong>GPU Required:</strong> No
                    </div>
                    <div class="mb-2">
                        <strong>VRAM:</strong> 0 GB
                    </div>
                    <div class="mb-0">
                        <strong>Runtime:</strong> 
                        <span class="text-muted">CPU execution</span>
                    </div>
                </div>
            </div>
        `;
    }
    
    // Regular GPU workload
    return `
        <div class="col-md-4 mb-3">
            <div class="border-start border-success border-3 ps-3">
                <h6 class="text-success mb-2">
                    <i class="bi bi-star me-1"></i>
                    Optimal
                </h6>
                <div class="mb-2">
                    <strong>GPU:</strong> 
                    <span class="badge bg-success ms-1">${analysis.enterprise_gpu.type}</span>
                </div>
                <div class="mb-2">
                    <strong>Quantity:</strong> ${analysis.enterprise_gpu.quantity}
                </div>
                <div class="mb-2">
                    <strong>VRAM:</strong> ${analysis.enterprise_gpu.vram_gb} GB
                </div>
                <div class="mb-0">
                    <strong>Runtime:</strong> 
                    <span class="text-muted">${analysis.enterprise_gpu.runtime}</span>
                </div>
            </div>
        </div>
    `;
}

function getArmCompatibilityBadge(compatibility) {
    if (compatibility === 'Highly Compatible' || compatibility === 'Compatible') {
        return `<span class="badge bg-success ms-1">${compatibility}</span>`;
    } else if (compatibility === 'Likely Compatible' || compatibility === 'Possibly Incompatible') {
        return `<span class="badge bg-warning ms-1">${compatibility}</span>`;
    } else {
        return `<span class="badge bg-danger ms-1">${compatibility}</span>`;
    }
}

function getComplianceClass(score) {
    if (score >= 90) return 'score-excellent';
    if (score >= 80) return 'score-good';
    if (score >= 70) return 'score-fair';
    if (score >= 60) return 'score-poor';
    return 'score-critical';
}

function renderComplianceDetails(analysis) {
    let html = '';
    
    if (analysis.structure_assessment) {
        html += '<h6 class="text-primary">Structure Assessment</h6>';
        for (const [key, value] of Object.entries(analysis.structure_assessment)) {
            html += `<div class="small mb-1"><strong>${key}:</strong> ${value}</div>`;
        }
    }
    
    if (analysis.content_quality_issues && analysis.content_quality_issues.length > 0) {
        html += '<h6 class="text-warning mt-3">Content Recommendations</h6>';
        analysis.content_quality_issues.forEach(issue => {
            html += `<div class="small mb-1">‚Ä¢ ${issue}</div>`;
        });
    }
    
    if (analysis.technical_recommendations && analysis.technical_recommendations.length > 0) {
        html += '<h6 class="text-info mt-3">Technical Recommendations</h6>';
        analysis.technical_recommendations.forEach(rec => {
            html += `<div class="small mb-1">‚Ä¢ ${rec}</div>`;
        });
    }
    
    return html || '<p class="text-muted">No detailed compliance information available.</p>';
}

function addConfidenceIndicator(reasonText, defaultConfidence) {
    const indicators = {
        'high': '<i class="bi bi-check-circle-fill text-success me-2 confidence-indicator" title="High confidence"></i>',
        'medium': '<i class="bi bi-check-circle text-warning me-2 confidence-indicator" title="Medium confidence"></i>',
        'low': '<i class="bi bi-question-circle text-muted me-2 confidence-indicator" title="Low confidence"></i>'
    };
    
    // Determine confidence based on content
    const actualConfidence = determineReasoningConfidence(reasonText, defaultConfidence);
    return indicators[actualConfidence] + reasonText;
}

function determineReasoningConfidence(reasonText, defaultConfidence) {
    const text = reasonText.toLowerCase();
    
    // High confidence indicators
    if (text.includes('detected') || text.includes('identified') || text.includes('confirmed') || 
        text.includes('workload') || text.includes('model') || text.includes('framework') ||
        text.includes('found') || text.includes('uses') || text.includes('contains')) {
        return 'high';
    }
    
    // Low confidence indicators
    if (text.includes('estimated') || text.includes('assumed') || text.includes('might') || 
        text.includes('could') || text.includes('may') || text.includes('unclear') ||
        text.includes('possibly') || text.includes('likely') || text.includes('suggests')) {
        return 'low';
    }
    
    // Return default confidence if no specific indicators found
    return defaultConfidence || 'medium';
}

function initializeCollapsibleSections() {
    // Add event listeners for collapsible sections
    const collapseElements = document.querySelectorAll('[data-bs-toggle="collapse"]');
    collapseElements.forEach(button => {
        const target = document.querySelector(button.getAttribute('data-bs-target'));
        if (target) {
            target.addEventListener('show.bs.collapse', function () {
                const icon = button.querySelector('i');
                const text = button.querySelector('.collapse-text');
                if (icon) icon.className = 'bi bi-chevron-up';
                if (text) text.textContent = 'Hide Details';
            });
            
            target.addEventListener('hide.bs.collapse', function () {
                const icon = button.querySelector('i');
                const text = button.querySelector('.collapse-text');
                if (icon) icon.className = 'bi bi-chevron-down';
                if (text) text.textContent = 'Show Details';
            });
        }
    });
}

function showError(message) {
    document.getElementById('errorMessage').textContent = message;
    document.getElementById('streamingError').classList.remove('d-none');
}

function showFriendlyMessage() {
    const errorDiv = document.getElementById('streamingError');
    const messageElement = document.getElementById('errorMessage');
    
    messageElement.innerHTML = `
        <div class="text-center">
            <i class="bi bi-info-circle fs-3 text-info mb-3"></i>
            <h6 class="mb-3">Welcome to the Notebook Analyzer!</h6>
            <p class="mb-3">
                It looks like you accessed this page directly. To analyze a Jupyter or marimo notebook 
                for GPU requirements and NVIDIA compliance, please start from the main page.
            </p>
            <div class="small text-muted mb-3">
                <i class="bi bi-lightbulb me-1"></i>
                You can analyze notebooks by URL or upload files directly
            </div>
        </div>
    `;
    
    // Update the button text and icon for better UX
    const tryAgainBtn = errorDiv.querySelector('.btn');
    if (tryAgainBtn) {
        tryAgainBtn.innerHTML = '<i class="bi bi-house me-1"></i>Start Analysis';
        tryAgainBtn.classList.remove('btn-outline-danger');
        tryAgainBtn.classList.add('btn-nvidia');
    }
    
    // Update the alert styling for a friendlier appearance
    const alertDiv = errorDiv.querySelector('.alert');
    if (alertDiv) {
        alertDiv.classList.remove('alert-danger');
        alertDiv.classList.add('alert-info');
    }
    
    // Update the header
    const headerElement = errorDiv.querySelector('h5');
    if (headerElement) {
        headerElement.innerHTML = '<i class="bi bi-compass me-2"></i>Ready to Analyze';
    }
    
    errorDiv.classList.remove('d-none');
}
</script>

<style>
.compliance-score {
    font-size: 2rem;
    font-weight: bold;
    line-height: 1;
}

.score-excellent { color: #198754; }
.score-good { color: #76b900; }
.score-fair { color: #fd7e14; }
.score-poor { color: #dc3545; }
.score-critical { color: #6f42c1; }

.reasoning-item {
    padding: 0.25rem 0.5rem;
    margin: 0.1rem 0;
    background: #f8f9fa;
    border-left: 3px solid #76b900;
    border-radius: 0 0.25rem 0.25rem 0;
    font-size: 0.875rem;
}

/* Enhanced styling for Phase 1 improvements */
.analysis-section.primary-analysis .reasoning-item {
    border-left-color: #76b900;
    background: #f8fdf8;
}

.analysis-section.secondary-analysis .reasoning-item {
    border-left-color: #6c757d;
    background: #f8f9fa;
    opacity: 0.9;
}

.llm-reasoning {
    border-left-width: 4px !important;
    font-weight: 500;
}

.static-reasoning {
    border-left-width: 2px !important;
    font-size: 0.8rem;
}

.analysis-section {
    margin-bottom: 1rem;
}

/* Phase 2: Enhanced UX styling */
.confidence-indicator {
    font-size: 0.875rem;
    opacity: 0.8;
    transition: opacity 0.2s ease;
}

.reasoning-item:hover .confidence-indicator {
    opacity: 1;
}

.reasoning-item {
    transition: all 0.2s ease;
    position: relative;
}

.reasoning-item:hover {
    transform: translateX(2px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

/* Collapsible section styling */
.btn[data-bs-toggle="collapse"] {
    transition: all 0.2s ease;
}

.btn[data-bs-toggle="collapse"]:hover {
    transform: translateY(-1px);
}

.btn[data-bs-toggle="collapse"] i {
    transition: transform 0.2s ease;
}

/* Methodology explanation styling */
.alert-info {
    border-left: 4px solid #0dcaf0;
    background: linear-gradient(135deg, #f8fdff 0%, #e3f2fd 100%);
}

.alert-info .alert-heading {
    color: #0c63e4;
}

/* Enhanced confidence styling */
.confidence-indicator.text-success {
    color: #198754 !important;
}

.confidence-indicator.text-warning {
    color: #ffc107 !important;
}

.confidence-indicator.text-muted {
    color: #6c757d !important;
}

/* Smooth animations */
.collapse {
    transition: height 0.3s ease;
}

.card {
    transition: box-shadow 0.2s ease;
}

.card:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.analysis-section h6 {
    font-size: 0.95rem;
    font-weight: 600;
}

/* Light and dark mode methodology panel styles */
.methodology-panel {
    padding: 1.25rem 1.5rem;
    border-radius: 0.75rem;
    border: 1px solid #d1d5db;
    background-color: #f9fafb;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
    margin-bottom: 1rem;
    color: #111827;
}

.methodology-heading {
    color: #1f2937;
    margin-bottom: 1rem;
    font-weight: 600;
    font-size: 1.1rem;
}

.methodology-divider {
    border-top: 1px solid #d1d5db;
    margin: 1rem 0;
    opacity: 1;
}

.methodology-list {
    margin-bottom: 1rem;
}

.methodology-list li {
    margin-bottom: 0.75rem;
    line-height: 1.5;
    color: #374151;
}

.methodology-list li strong {
    color: #111827;
    font-weight: 600;
}

.confidence-indicators {
    color: #374151;
    line-height: 1.8;
    font-size: 0.9rem;
}

.confidence-low-icon {
    color: #6b7280;
}

/* Dark mode overrides */
@media (prefers-color-scheme: dark) {
    .methodology-panel {
        background-color: #1f2937 !important;
        border-color: #374151 !important;
        color: #f9fafb !important;
    }
    
    .methodology-heading {
        color: #f9fafb !important;
    }
    
    .methodology-divider {
        border-top-color: #4b5563 !important;
    }
    
    .confidence-indicators {
        color: #e5e7eb !important;
    }
    
    .confidence-low-icon {
        color: #9ca3af !important;
    }
    
    .methodology-list li {
        color: #e5e7eb !important;
    }
    
    .methodology-list li strong {
        color: #f9fafb !important;
    }
}

/* Force dark mode styles when body has dark theme */
body[data-bs-theme="dark"] .methodology-panel,
.dark .methodology-panel {
    background-color: #1f2937 !important;
    border-color: #374151 !important;
    color: #f9fafb !important;
}

body[data-bs-theme="dark"] .methodology-heading,
.dark .methodology-heading {
    color: #f9fafb !important;
}

body[data-bs-theme="dark"] .methodology-divider,
.dark .methodology-divider {
    border-top-color: #4b5563 !important;
}

body[data-bs-theme="dark"] .confidence-indicators,
.dark .confidence-indicators {
    color: #e5e7eb !important;
}

body[data-bs-theme="dark"] .confidence-low-icon,
.dark .confidence-low-icon {
    color: #9ca3af !important;
}

body[data-bs-theme="dark"] .methodology-list li,
.dark .methodology-list li {
    color: #e5e7eb !important;
}

body[data-bs-theme="dark"] .methodology-list strong,
.dark .methodology-list strong {
    color: #f9fafb !important;
}
</style>
{% endblock %} 